name: Run GTFS Update Cron Job

on:
  schedule:
    - cron: '0 3 1 * *' # En g√•ng i m√•naden kl 03:00 UTC den f√∂rsta dagen i m√•naden
  workflow_dispatch:     # G√∂r det m√∂jligt att k√∂ra manuellt fr√•n GitHub

jobs:
  run-cron:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Clean dist directory
        run: rm -rf dist

      - name: Compile TypeScript
        run: npx tsc --project tsconfig.json

      - name: Run GTFS update script
        run: node scripts/updateGTFSData.cjs
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GTFS_REGIONAL_STATIC: ${{ secrets.GTFS_REGIONAL_STATIC }}
          
      - name: Ping Discord if job failed
        if: failure()
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                "username": "Cron Monitor ü§ñ",
                "avatar_url": "https://i.imgur.com/4M34hi2.png",
                "content": "‚ùå **GTFS Cron Job Failed**\nCheck the logs here: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }' \
              $DISCORD_WEBHOOK_URL
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Ping Discord if job completed
        if: success()
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
                "username": "Cron Monitor ü§ñ",
                "avatar_url": "https://i.imgur.com/4M34hi2.png",
                "content": "üéâ **GTFS Cron Job completed**\nCheck the logs here: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }' \
              $DISCORD_WEBHOOK_URL
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
